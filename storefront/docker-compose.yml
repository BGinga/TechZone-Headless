services:
  web-dev:
    profiles: ["dev"]
    image: node:20-alpine
    container_name: storefront_web_dev
    working_dir: /app
    ports:
      - "3000:3000"
    env_file:
      - .env.local
    volumes:
      - .:/app
      - /app/node_modules
    command: sh -c "npm ci && HOST=0.0.0.0 PORT=3000 npm run dev"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    restart: unless-stopped

  web-prod:
    profiles: ["prod"]
    build: .
    container_name: storefront_web
    ports:
      - "3001:3000"
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000',res=>process.exit(res.statusCode===200?0:1)).on('error',()=>process.exit(1))",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
